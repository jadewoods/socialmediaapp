<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f1f2f6;
      padding-bottom: 80px;
    }

    header {
      background: #6e8efb;
      color: white;
      padding: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .container {
      max-width: 600px;
      margin: auto;
      padding: 14px;
    }

    .post-box {
      background: white;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    textarea {
      width: 100%;
      height: 70px;
      padding: 10px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    button {
      margin-top: 8px;
      padding: 8px 14px;
      border: none;
      background: #6e8efb;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .post {
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 14px;
    }

    .reactions {
      display: flex;
      gap: 14px;
      margin-top: 8px;
    }

    .reaction-btn {
      background: #eee;
      color: black;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 13px;
      cursor: pointer;
    }

    .active-like {
      background: #6e8efb;
      color: white;
    }

    .active-dislike {
      background: #e74c3c;
      color: white;
    }

    .comments {
      background: #f5f6fa;
      padding: 8px;
      border-radius: 8px;
      margin-top: 8px;
    }

    .comment {
      font-size: 13px;
      margin-top: 5px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 4px;
    }

    .comment-box {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .comment-box input {
      flex: 1;
      padding: 6px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .logout {
      background: red;
      font-size: 12px;
    }
  </style>
</head>

<body>

<header>
  <strong>LADS Feed</strong>
  <button class="logout" onclick="logout()">Log Out</button>
</header>

<div class="container">

  <div class="post-box">
    <textarea id="newPost" placeholder="What's on your mind?"></textarea>
    <button onclick="createPost()">Post</button>
  </div>

  <div id="feed"></div>

</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDfo7yUsxw_0DG6JS09A4jOxVZhdSMYQyQ",
    authDomain: "lads-7a3a2.firebaseapp.com",
    projectId: "lads-7a3a2",
    messagingSenderId: "294006575046",
    appId: "1:294006575046:web:e42226b89015a9c515ecc7"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser = null;

  auth.onAuthStateChanged(user => {
    if (!user) window.location.href = "login.html";
    currentUser = user;
    loadFeed();
  });

  function createPost() {
    const text = newPost.value.trim();
    if (!text) return;

    db.collection("posts").add({
      text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    newPost.value = "";
  }

  function loadFeed() {
    db.collection("posts").orderBy("createdAt", "desc")
      .onSnapshot(snapshot => {
        feed.innerHTML = "";
        snapshot.forEach(doc => {
          const post = doc.data();
          const id = doc.id;

          feed.innerHTML += `
            <div class="post">
              <div>${post.text}</div>

              <div class="reactions">
                <div id="like-${id}" class="reaction-btn" onclick="react('${id}', 'like')">üëç 0</div>
                <div id="dislike-${id}" class="reaction-btn" onclick="react('${id}', 'dislike')">üëé 0</div>
              </div>

              <div class="comments">
                <div id="comments-${id}"></div>

                <div class="comment-box">
                  <input id="comment-${id}" placeholder="Write a comment..." />
                  <button onclick="addComment('${id}')">Send</button>
                </div>
              </div>
            </div>
          `;

          loadReactions(id);
          loadComments(id);
        });
      });
  }

  function react(postId, type) {
    const ref = db.collection("posts").doc(postId)
      .collection("reactions").doc(currentUser.uid);

    ref.set({ type });
  }

  function loadReactions(postId) {
    db.collection("posts").doc(postId)
      .collection("reactions")
      .onSnapshot(snapshot => {

        let likes = 0;
        let dislikes = 0;
        let userReaction = null;

        snapshot.forEach(doc => {
          const r = doc.data().type;
          if (r === "like") likes++;
          if (r === "dislike") dislikes++;
          if (doc.id === currentUser.uid) userReaction = r;
        });

        const likeBtn = document.getElementById(`like-${postId}`);
        const dislikeBtn = document.getElementById(`dislike-${postId}`);

        likeBtn.innerText = `üëç ${likes}`;
        dislikeBtn.innerText = `üëé ${dislikes}`;

        likeBtn.classList.remove("active-like");
        dislikeBtn.classList.remove("active-dislike");

        if (userReaction === "like") likeBtn.classList.add("active-like");
        if (userReaction === "dislike") dislikeBtn.classList.add("active-dislike");
      });
  }

  function addComment(postId) {
    const input = document.getElementById(`comment-${postId}`);
    const text = input.value.trim();
    if (!text) return;

    db.collection("posts").doc(postId)
      .collection("comments")
      .add({
        text,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

    input.value = "";
  }

  function loadComments(postId) {
    db.collection("posts").doc(postId)
      .collection("comments")
      .orderBy("createdAt")
      .onSnapshot(snapshot => {
        const box = document.getElementById(`comments-${postId}`);
        box.innerHTML = "";
        snapshot.forEach(doc => {
          box.innerHTML += `<div class="comment">${doc.data().text}</div>`;
        });
      });
  }

  function logout() {
    auth.signOut().then(() => location.href = "login.html");
  }
</script>

</body>
</html>
